---
title: 登录
icon: sign-in-alt
article: false
category:
  - 项目
  - 黑马点评
tag:
  - 登录
  - 身份验证
date: 2026-02-15
---

# 一、身份认证与保持登录的三种模式

## 模式1：Cookie + Session（传统模式）

暂时无法在南开飞书文档外展示此内容

具体流程：

1. 用户输入用户名密码提交登录
2. 服务器验证通过，创建Session并存储用户信息
3. 服务器响应：`Set-Cookie: JSESSIONID=abc123; HttpOnly`
4. 浏览器存储Cookie
5. 后续请求自动携带：`Cookie: JSESSIONID=abc123`
6. 服务器通过SessionID查找Session，验证用户身份

## 模式2：Token方案

暂时无法在南开飞书文档外展示此内容

Token流程细节（以JWT为例）：

1. 客户端提交认证信息
2. 服务器验证成功后生成JWT：
3. Header.Payload.Signature           

```
{"userId": "123","username": "john","exp": 1672531200, "iat": 1672527600  // 签发时间}
```

1. 服务器返回JWT给客户端
2. 客户端存储JWT
3. 后续请求手动添加到Header
4. 服务器验证签名，解析Payload获取用户信息

## 模式3：Session + Token混合

暂时无法在南开飞书文档外展示此内容

## 小结

**传统 Session vs Token-Session (现代无状态 Session)：**

- **传统 Session**：客户端只持有一个 SessionID，服务器存储所有用户数据（如 `userId`、`name`、`permissions` 等）。
- **Token-Session**：客户端持有完整的 Token（包含用户数据），服务器不存储用户数据，只验证 Token 的签名。

#### 1. **Token 验证流程**

- **Access Token 验证**：服务器只验证 Token 的签名和过期时间，不查询数据库，除非使用了黑名单机制。
- **Refresh Token 刷新**：只有在 Access Token 过期或验证失败时，客户端才使用 Refresh Token 进行数据库查询以获取新的 Access Token。

#### 2. **刷新逻辑**

- **返回错误而非延长 Token**：服务器不会主动延长 Access Token 的有效期。若 Token 过期，服务器返回 `401` 错误，提示客户端使用 Refresh Token 刷新 Access Token。
- **控制 Refresh Token 使用频率和撤销**：这种设计有助于控制 Refresh Token 的使用频率和防止其滥用。

#### 3. **Refresh Token 刷新流程**

- **客户端带 Refresh Token 请求刷新**：通过 HttpOnly Cookie 自动携带 Refresh Token。
- **服务器验证流程**：
  - 计算 Token 哈希，查数据库或 Redis 对比存储记录。
  - 检查 Token 是否被撤销（`revoked: true`）。
  - 对比 Token 的过期时间（`expiresAt`）。
  - 可选：检查刷新频率、设备指纹等。
- **验证通过后**：服务器生成新的 Access Token 并可选择更新 Refresh Token（Token 轮换），同时更新最后使用时间。
- **返回结果**：返回新的 Access Token 或错误信息。

#### 4. **安全设计原则**

- **Refresh Token 的严格验证**：由于 Refresh Token 是长期凭证，必须对其进行严格管理和撤销控制。服务器存储的过期时间（`expiresAt`）是权威的，客户端 Cookie 的过期时间仅供参考。即便客户端 Cookie 仍有效，如果服务器端记录已过期或撤销，刷新请求将被拒绝。
